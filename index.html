<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tune Map Data Extractor</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Style for table */
        th, td {
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl bg-white rounded-lg shadow-xl p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Tune Map Data Extractor</h1>
            <p class="text-gray-500 mt-2">Copy text from Tune Map into the text box below.</p>
            <a href="https://imgur.com/a/kKle0oS" target="_blank" class="text-blue-500 hover:underline font-semibold">example text to copy</a>
        </header>

        <!-- Text Input Section -->
        <div id="text-input-container">
            <textarea id="text-input" class="w-full h-48 p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Paste the text here"></textarea>
            <button id="process-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition">
                Process Text
            </button>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="hidden mt-8">
            <!-- Extracted Table -->
            <div id="table-container">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold text-gray-700">Extracted Data</h2>
                    <button id="copy-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">
                        Copy Table Data
                    </button>
                </div>
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table id="data-table" class="min-w-full bg-white">
                        <!-- Table content will be generated by JavaScript -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const textInput = document.getElementById('text-input');
        const processButton = document.getElementById('process-button');
        const resultsContainer = document.getElementById('results-container');
        const tableContainer = document.getElementById('table-container');
        const dataTable = document.getElementById('data-table');
        const copyButton = document.getElementById('copy-button');

        // --- Predefined Table Headers ---
        const TARGET_HEADERS = [
            'Symbol', 'Strategy', 'Buy Threshold', 'Sell Threshold', 'Signal Period', 'Fast Period', 'Slow Period', 'Alpha', 'Beta',
            'Norm. Returns', 'Hit Rate', '# of Trades', 'Returns Multiplier', '# of Trades Variation', 'Hit Rate',
            'B&H Returns', 'Strategy Returns', 'Hysteresis Returns', 'Avg Win', 'Avg Loss', 'Avg Win/Loss',
            'B&H Period', 'Strategy Period', 'B&H Drawdown', 'Max Single Trade DD', 'Avg Win/Med Win'
        ];

        // --- Event Listener for the Process Button ---
        processButton.addEventListener('click', () => {
            const inputText = textInput.value;
            if (inputText.trim() === '') {
                alert('Please paste some text into the box.');
                return;
            }
            parseTextAndDisplayTable(inputText);
        });
        
        /**
         * Parses the input text, maps it to predefined headers, and generates the table.
         * @param {string} text The raw text pasted by the user.
         */
        function parseTextAndDisplayTable(text) {
            // This array will store all found [key, value] pairs in the order they appear.
            const parsedPairs = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line && !['Parameters', 'Statistics'].includes(line));

            // --- New, more robust parsing logic ---
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Case 1: "Key: Value" on the same line
                const singleLineMatch = line.match(/^([^:]+):\s*(.+)$/);
                if (singleLineMatch) {
                    parsedPairs.push([singleLineMatch[1].trim(), singleLineMatch[2].trim()]);
                    continue;
                }

                // Case 2: "Key:" on one line, "Value" on the next
                if (line.endsWith(':')) {
                    const key = line.slice(0, -1).trim();
                    const nextLine = lines[i + 1];
                    
                    if (nextLine && !nextLine.includes(':')) {
                        parsedPairs.push([key, nextLine]);
                        i++; // Skip the next line since we've consumed it as a value
                    } else {
                        // Key has no value on the next line
                        parsedPairs.push([key, '']);
                    }
                }
            }

            // --- Step 3: Build the final result row using an ordered search ---
            const resultRow = [];
            const usedIndexes = new Set(); 
            const normalizeKey = (key) => key.toLowerCase().replace(/[^a-z0-9]/g, '');

            for (const targetHeader of TARGET_HEADERS) {
                let foundValue = '';
                const normalizedTarget = normalizeKey(targetHeader);

                for (let i = 0; i < parsedPairs.length; i++) {
                    if (usedIndexes.has(i)) continue;

                    const [parsedKey, parsedValue] = parsedPairs[i];
                    if (normalizeKey(parsedKey) === normalizedTarget) {
                        foundValue = parsedValue;
                        usedIndexes.add(i); 
                        break; 
                    }
                }
                
                if (targetHeader === 'Symbol' && foundValue) {
                    foundValue = foundValue.toUpperCase();
                }
                
                resultRow.push(foundValue);
            }

            // Generate the table HTML
            const thead = `<thead class="bg-gray-100"><tr>${TARGET_HEADERS.map(h => `<th class="p-3 text-left text-sm font-semibold text-gray-600">${h}</th>`).join('')}</tr></thead>`;
            const tbody = `<tbody><tr class="border-t border-gray-200">${resultRow.map(d => `<td class="p-3 text-sm text-gray-700">${d}</td>`).join('')}</tr></tbody>`;
            
            dataTable.innerHTML = thead + tbody;
            resultsContainer.classList.remove('hidden'); 
        }

        // --- Copy to Clipboard Functionality ---
        copyButton.addEventListener('click', () => {
            let tableText = '';
            const dataRow = dataTable.querySelector('tbody tr');
            if(dataRow) {
                const cols = dataRow.querySelectorAll('td');
                tableText = Array.from(cols).map(col => col.innerText).join('\t'); 
            }

            const textArea = document.createElement("textarea");
            textArea.value = tableText;
            
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => { copyButton.textContent = 'Copy Table Data'; }, 2000);
                } else {
                    alert('Failed to copy table. Please try again.');
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy table. Please try again.');
            }

            document.body.removeChild(textArea);
        });
    </script>
</body>
</html>
