<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tune Map Data Extractor</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Style for table */
        th, td {
            white-space: nowrap;
        }
        /* Styles for the delete button */
        .delete-btn {
            visibility: hidden; /* Hidden by default */
            cursor: pointer;
            color: #ef4444; /* Red color */
            font-weight: bold;
            font-size: 1.25rem;
            line-height: 1;
            padding: 0 0.5rem;
        }
        /* Show delete button when hovering over the table row */
        tr:hover .delete-btn {
            visibility: visible;
        }
        /* Simple transition for page switching */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl bg-white rounded-lg shadow-xl p-6 md:p-8">
        
        <!-- Main Application Page -->
        <div id="main-app" class="page active">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Tune Map Data Extractor</h1>
                <p class="text-gray-500 mt-2">Copy text from Tune Map into the text box below.</p>
                <a href="https://imgur.com/a/kKle0oS" target="_blank" class="text-blue-500 hover:underline font-semibold">example text to copy</a>
            </header>

            <!-- Text Input Section -->
            <div id="text-input-container">
                <textarea id="text-input" class="w-full h-48 p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Paste the text here"></textarea>
                <button id="process-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition">
                    Process Text
                </button>
            </div>

            <!-- Results Section -->
            <div id="results-container" class="hidden mt-8">
                <div id="table-container">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-semibold text-gray-700">Extracted Data</h2>
                        <button id="copy-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            Copy Table Data
                        </button>
                    </div>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table id="data-table" class="min-w-full bg-white">
                            <!-- Table content will be generated by JavaScript -->
                        </table>
                    </div>
                </div>
            </div>
            <footer class="text-center mt-8">
                <a href="#" id="help-link" class="text-sm text-blue-500 hover:underline">Help</a>
            </footer>
        </div>

        <!-- Help/Documentation Page -->
        <div id="help-page" class="page">
             <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">User Guide</h1>
            </header>
            <div class="max-w-none text-gray-700">
                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">1. Summary</h4>
                <p class="mb-4">The Tune Map Data Extractor is a simple yet powerful web-based tool designed to streamline the process of collecting and organizing financial data. It allows users to copy a block of text containing financial parameters and statistics from the Tune Map platform and instantly convert it into a structured, spreadsheet-ready table.</p>
                <p class="mb-4">This tool is built to handle specific text formats, including data points that are on the same line as their labels (e.g., "Hit Rate: 50%") and those where the value appears on the line below the label (e.g., "Symbol: \n AAPL").</p>
                
                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">2. Use Cases</h4>
                <ul class="list-disc list-inside space-y-2 mb-4 ml-4">
                    <li><strong>Financial Analysts & Traders:</strong> Quickly compile performance data from multiple backtests into a single table for comparison and analysis.</li>
                    <li><strong>Researchers:</strong> Efficiently gather and organize data for academic or personal research projects on trading strategies.</li>
                    <li><strong>Hobbyists:</strong> Easily track the results of different trading algorithm parameters without manual data entry.</li>
                </ul>

                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">3. How to Use the Tool</h4>
                <ol class="list-decimal list-inside space-y-2 mb-4 ml-4">
                    <li><strong>Copy Text:</strong> Navigate to the Tune Map page and select and copy the block of text containing the "Parameters" and "Statistics" you want to extract.</li>
                    <li><strong>Paste Text:</strong> Paste the copied text into the large text box in the extractor tool.</li>
                    <li><strong>Process:</strong> Click the "Process Text" button.</li>
                    <li><strong>Review:</strong> The tool will instantly parse the text and display it as a new row in the "Extracted Data" table below.</li>
                    <li><strong>Repeat:</strong> The text box will automatically clear, allowing you to paste a new block of text to add another row.</li>
                    <li><strong>Copy Data:</strong> Once you have extracted all the desired data, click the "Copy Table Data" button to copy the entire table to your clipboard, ready to be pasted into a spreadsheet.</li>
                </ol>

                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">4. Core Functionalities</h4>
                <p class="mb-4"><strong class="font-semibold text-gray-700">Adding Data:</strong> To add a new row of data, simply paste a new block of text into the input box and click "Process Text." The tool will add the newly extracted data as a new row at the bottom of the table. There is no practical limit to the number of rows you can add.</p>
                <p class="mb-4"><strong class="font-semibold text-gray-700">Removing Data:</strong> If you make a mistake or wish to remove a specific entry, simply hover your mouse over the row you want to delete. A red <strong>&times;</strong> will appear in the leftmost column. Clicking this <strong>&times;</strong> will immediately and permanently delete that row from the table.</p>
                <p class="mb-4"><strong class="font-semibold text-gray-700">Copying the Table:</strong> The "Copy Table Data" button is designed for easy export to spreadsheet applications like Google Sheets or Microsoft Excel. It copies only the data from the table (not the headers or the delete buttons) and formats it with tabs between each cell. When you paste this into a spreadsheet, the data will automatically populate the correct columns.</p>

                <h4 class="text-xl font-semibold text-gray-800 mb-2 mt-6">5. Technical Details & Known Limitations</h4>
                <ul class="list-disc list-inside space-y-2 mb-4 ml-4">
                    <li><strong>Parsing Logic:</strong> The tool works by recognizing labels that end with a colon (<code>:</code>). It can handle values that are on the same line as the label or on the immediately following line.</li>
                    <li><strong>Duplicate Labels:</strong> The tool is designed to handle duplicate labels (like "Hit Rate") by processing the text in order and filling the columns from left to right.</li>
                    <li><strong>Capitalization:</strong> The "Symbol" value is automatically converted to uppercase for data consistency.</li>
                    <li><strong>Limitations:</strong> The tool's accuracy depends on the formatting of the pasted text. It may fail to extract data correctly if a label is missing its colon or if a value itself contains a colon.</li>
                </ul>
                <p class="mt-4">For best results, always copy the text directly from the source without making manual edits.</p>
            </div>
             <footer class="text-center mt-8">
                <a href="#" id="back-link" class="text-sm text-blue-500 hover:underline">Back to Extractor</a>
            </footer>
        </div>

    </div>

    <script>
        // --- DOM Element References ---
        const textInput = document.getElementById('text-input');
        const processButton = document.getElementById('process-button');
        const resultsContainer = document.getElementById('results-container');
        const tableContainer = document.getElementById('table-container');
        const dataTable = document.getElementById('data-table');
        const copyButton = document.getElementById('copy-button');
        const mainAppPage = document.getElementById('main-app');
        const helpPage = document.getElementById('help-page');
        const helpLink = document.getElementById('help-link');
        const backLink = document.getElementById('back-link');

        // --- Predefined Table Headers ---
        const TARGET_HEADERS = [
            'Symbol', 'Strategy', 'Buy Threshold', 'Sell Threshold', 'Signal Period', 'Fast Period', 'Slow Period', 'Alpha', 'Beta',
            'Norm. Returns', 'Hit Rate', '# of Trades', 'Returns Multiplier', '# of Trades Variation', 'Hit Rate',
            'B&H Returns', 'Strategy Returns', 'Hysteresis Returns', 'Avg Win', 'Avg Loss', 'Avg Win/Loss',
            'B&H Period', 'Strategy Period', 'B&H Drawdown', 
            'Max Single Trade DD', 'Avg Win/Med Win'
        ];

        // --- Page Navigation ---
        helpLink.addEventListener('click', (e) => {
            e.preventDefault();
            mainAppPage.classList.remove('active');
            helpPage.classList.add('active');
        });

        backLink.addEventListener('click', (e) => {
            e.preventDefault();
            helpPage.classList.remove('active');
            mainAppPage.classList.add('active');
        });

        // --- Event Listener for the Process Button ---
        processButton.addEventListener('click', () => {
            const inputText = textInput.value;
            if (inputText.trim() === '') {
                alert('Please paste some text into the box.');
                return;
            }
            parseTextAndDisplayTable(inputText);
        });
        
        /**
         * Parses the input text, maps it to predefined headers, and generates the table.
         * @param {string} text The raw text pasted by the user.
         */
        function parseTextAndDisplayTable(text) {
            const parsedPairs = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line && !['Parameters', 'Statistics'].includes(line));

            // --- Step 1: Parse all key-value pairs from the text ---
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const singleLineMatch = line.match(/^([^:]+):\s*(.+)$/);
                if (singleLineMatch) {
                    parsedPairs.push([singleLineMatch[1].trim(), singleLineMatch[2].trim()]);
                } else if (line.endsWith(':')) {
                    const key = line.slice(0, -1).trim();
                    const nextLine = lines[i + 1];
                    if (nextLine && !nextLine.includes(':')) {
                        parsedPairs.push([key, nextLine]);
                        i++; 
                    } else {
                        parsedPairs.push([key, '']);
                    }
                }
            }
            
            // --- Step 2: Create a map of normalized keys to an array of their values ---
            const normalizeKey = (key) => key.toLowerCase().replace(/[^a-z0-9]/g, '');
            const dataMap = new Map();
            for (const [key, value] of parsedPairs) {
                const normalizedKey = normalizeKey(key);
                if (!dataMap.has(normalizedKey)) {
                    dataMap.set(normalizedKey, []);
                }
                dataMap.get(normalizedKey).push(value);
            }

            // --- Step 3: Build the final result row by matching headers in order ---
            const resultRow = [];
            const headerCount = new Map();

            for (const targetHeader of TARGET_HEADERS) {
                const normalizedTarget = normalizeKey(targetHeader);
                const count = headerCount.get(normalizedTarget) || 0;
                
                const values = dataMap.get(normalizedTarget);
                let foundValue = (values && values.length > count) ? values[count] : '';

                headerCount.set(normalizedTarget, count + 1);
                
                // Special formatting rules
                if (targetHeader === 'Symbol' && foundValue) {
                    foundValue = foundValue.toUpperCase();
                }
                
                // Special handling to extract only numbers for Period columns
                if ((targetHeader.includes('B&H Period') || targetHeader.includes('Strategy Period')) && foundValue) {
                    const numberMatch = foundValue.match(/[\d.]+/); // Extract numbers and decimals
                    foundValue = numberMatch ? numberMatch[0] : '';
                }
                
                resultRow.push(foundValue);
            }

            // --- Step 4: Generate and append table content ---
            if (!dataTable.querySelector('thead')) {
                const thead = document.createElement('thead');
                thead.className = 'bg-gray-100';
                thead.innerHTML = `<tr><th class="p-3 w-12"></th>${TARGET_HEADERS.map(h => `<th class="p-3 text-left text-sm font-semibold text-gray-600">${h}</th>`).join('')}</tr>`;
                dataTable.appendChild(thead);
                const tbody = document.createElement('tbody');
                dataTable.appendChild(tbody);
            }

            const tbody = dataTable.querySelector('tbody');
            const newTr = document.createElement('tr');
            newTr.className = 'border-t border-gray-200 hover:bg-gray-50';
            const dataCellsHTML = resultRow.map(d => `<td class="p-3 text-sm text-gray-700">${d}</td>`).join('');
            newTr.innerHTML = `<td class="p-3 text-center"><span class="delete-btn">&times;</span></td>` + dataCellsHTML;
            tbody.appendChild(newTr);
            
            resultsContainer.classList.remove('hidden');
            textInput.value = '';
            textInput.placeholder = 'Input more text to add another row to the table.';
        }

        // --- Event Delegation for Delete Buttons ---
        dataTable.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('delete-btn')) {
                const row = e.target.closest('tr');
                row.remove();
                
                const tbody = dataTable.querySelector('tbody');
                if (tbody && tbody.rows.length === 0) {
                    resultsContainer.classList.add('hidden');
                    dataTable.innerHTML = '';
                }
            }
        });

        // --- Copy to Clipboard Functionality ---
        copyButton.addEventListener('click', () => {
            const allRows = [];
            const rows = dataTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                const rowText = Array.from(cols).slice(1).map(col => col.innerText).join('\t'); 
                allRows.push(rowText);
            });
            
            const tableText = allRows.join('\n');
            const textArea = document.createElement("textarea");
            textArea.value = tableText;
            
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => { copyButton.textContent = 'Copy Table Data'; }, 2000);
                } else {
                    alert('Failed to copy table. Please try again.');
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy table. Please try again.');
            }

            document.body.removeChild(textArea);
        });
    </script>
</body>
</html>
